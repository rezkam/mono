#!/bin/sh
set -e

echo "Running pre-commit checks..."

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$STAGED_GO_FILES" ]; then
    # Validate gofmt (quiet on success)
    UNFORMATTED=""
    for file in $STAGED_GO_FILES; do
        if [ -f "$file" ]; then
            if gofmt -l "$file" | grep -q .; then
                UNFORMATTED="$UNFORMATTED\n  $file"
            fi
        fi
    done
    if [ -n "$UNFORMATTED" ]; then
        echo ""
        echo "----------------------------------------"
        echo "FAIL: Formatting errors"
        echo "----------------------------------------"
        echo "Unformatted files:$UNFORMATTED"
        echo ""
        echo "Run 'just fmt' to fix."
        echo "----------------------------------------"
        exit 1
    fi

    # Run golangci-lint (only show output on failure)
    if command -v golangci-lint >/dev/null 2>&1; then
        golangci-lint config verify >/dev/null 2>&1
        PACKAGES=$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|' | tr '\n' ' ')
        if [ -n "$PACKAGES" ]; then
            LINT_OUTPUT=$(golangci-lint run $PACKAGES 2>&1) || {
                echo ""
                echo "----------------------------------------"
                echo "FAIL: golangci-lint"
                echo "----------------------------------------"
                echo "$LINT_OUTPUT"
                echo "----------------------------------------"
                exit 1
            }
        fi
    fi

    # Build and run timezone linter (quiet on success)
    if [ ! -f "./timeutc" ]; then
        just build-timeutc-linter >/dev/null 2>&1
    fi
    LINT_PACKAGES=$(echo "$PACKAGES" | tr ' ' '\n' | grep -v testdata | grep -v sqlcgen | grep -v '^ *$' | tr '\n' ' ')
    if [ -n "$(echo "$LINT_PACKAGES" | xargs)" ]; then
        TIMEUTC_OUTPUT=$(./timeutc $LINT_PACKAGES 2>&1) || {
            echo ""
            echo "----------------------------------------"
            echo "FAIL: Timezone linter"
            echo "----------------------------------------"
            echo "$TIMEUTC_OUTPUT"
            echo "----------------------------------------"
            exit 1
        }
    fi

    # Build and run interface{} linter (quiet on success)
    if [ ! -f "./nointerface" ]; then
        just build-nointerface-linter >/dev/null 2>&1
    fi
    if [ -n "$(echo "$LINT_PACKAGES" | xargs)" ]; then
        INTERFACE_OUTPUT=$(./nointerface $LINT_PACKAGES 2>&1) || {
            echo ""
            echo "----------------------------------------"
            echo "FAIL: Interface linter"
            echo "----------------------------------------"
            echo "$INTERFACE_OUTPUT"
            echo "----------------------------------------"
            exit 1
        }
    fi

    # Run tests (quiet on success)
    TEST_OUTPUT=$(just test 2>&1) || {
        echo ""
        echo "----------------------------------------"
        echo "FAIL: Unit tests"
        echo "----------------------------------------"
        echo "$TEST_OUTPUT"
        echo "----------------------------------------"
        exit 1
    }
else
    echo "No staged Go files to check."
fi

echo "OK: All pre-commit checks passed"
exit 0
