#!/bin/sh
set -e

echo "Running pre-commit checks..."

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$STAGED_GO_FILES" ]; then
    echo "Validating gofmt on staged files..."
    for file in $STAGED_GO_FILES; do
        if [ -f "$file" ]; then
            # Check if file is properly formatted
            if ! gofmt -l "$file" | grep -q .; then
                :
            else
                echo "File $file is not properly formatted. Run 'make fmt' to fix."
                exit 1
            fi
        fi
    done

    echo "Running golangci-lint on staged files..."
    if command -v golangci-lint >/dev/null 2>&1; then
        golangci-lint config verify
        # Extract unique package directories from staged files
        PACKAGES=$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|' | tr '\n' ' ')
        if [ -n "$PACKAGES" ]; then
            golangci-lint run $PACKAGES
        fi
    else
        echo "Warning: golangci-lint not found, skipping..."
    fi

    echo "Running timezone linter on staged files..."
    # Build the linter if it doesn't exist
    if [ ! -f "./timeutc" ]; then
        make build-timeutc-linter
    fi
    # Run on packages instead of individual files
    if [ -n "$PACKAGES" ]; then
        ./timeutc $PACKAGES
    fi

    echo "Running tests..."
    make test
else
    echo "No staged Go files to check."
fi

echo "All checks passed!"
exit 0
