name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mono_test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Install Code Generators
        run: |
          go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
          go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest

      - name: Generate Code (OpenAPI, sqlc)
        run: |
          oapi-codegen -config api/openapi/oapi-codegen.yaml api/openapi/mono.yaml
          sqlc generate

      - name: Verify Generated Code In Sync
        run: |
          git diff --exit-code || (echo "Generated code is out of sync. Run 'make gen' and commit." && exit 1)

      - name: Security Scan
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Verify sqlc Generated Code
        run: |
          sqlc generate
          git diff --exit-code internal/infrastructure/persistence/postgres/sqlcgen/ || (echo "sqlc generated code is out of sync. Run 'make gen-sqlc' and commit." && exit 1)

      - name: Install golangci-lint
        run: |
          VERSION="2.7.2"
          CHECKSUM="ce46a1f1d890e7b667259f70bb236297f5cf8791a9b6b98b41b283d93b5b6e88"
          wget -q "https://github.com/golangci/golangci-lint/releases/download/v${VERSION}/golangci-lint-${VERSION}-linux-amd64.tar.gz"
          echo "${CHECKSUM}  golangci-lint-${VERSION}-linux-amd64.tar.gz" | sha256sum -c -
          tar -xzf "golangci-lint-${VERSION}-linux-amd64.tar.gz"
          sudo mv "golangci-lint-${VERSION}-linux-amd64/golangci-lint" /usr/local/bin/
          golangci-lint --version

      - name: Run Linters
        run: golangci-lint run

      - name: Run Unit Tests
        run: go list ./... | grep -v '/tests/integration' | grep -v '/tests/e2e' | xargs go test -v

      - name: Apply Database Migrations
        run: |
          go run -tags 'no_sqlite' github.com/pressly/goose/v3/cmd/goose@latest \
            -dir internal/infrastructure/persistence/postgres/migrations \
            postgres \
            "postgres://postgres:postgres@localhost:5432/mono_test?sslmode=disable" \
            up

      - name: Run Integration Tests
        run: go test -v -p 1 ./tests/integration/... -count=1
        env:
          MONO_STORAGE_DSN: "postgres://postgres:postgres@localhost:5432/mono_test?sslmode=disable"

      - name: Build Binary
        run: go build -o mono-server ./cmd/server
