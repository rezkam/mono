openapi: 3.0.3
info:
  title: Mono API
  version: 1.0.0
  description: RESTful API for todo list and item management with recurring templates

servers:
  - url: http://localhost:8081/api
    description: Local development

security:
  - BearerAuth: []

paths:
  /v1/lists:
    post:
      operationId: createList
      summary: Create a new todo list
      tags: [Lists]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateListRequest'
      responses:
        '201':
          description: List created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      operationId: listLists
      summary: List all todo lists with pagination
      tags: [Lists]
      parameters:
        - name: page_size
          in: query
          description: Number of lists per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
        - name: page_token
          in: query
          description: Page token from previous response
          schema:
            type: string
        - name: title_contains
          in: query
          description: Filter by title substring (case-insensitive)
          schema:
            type: string
        - name: created_after
          in: query
          description: Filter lists created after this time
          schema:
            type: string
            format: date-time
        - name: created_before
          in: query
          description: Filter lists created before this time
          schema:
            type: string
            format: date-time
        - name: sort_by
          in: query
          description: Field to sort by
          schema:
            type: string
            enum: [created_at, title]
            default: created_at
        - name: sort_dir
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Lists retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListListsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/lists/{id}:
    get:
      operationId: getList
      summary: Get a todo list by ID
      description: Returns list metadata. Use GET /v1/lists/{list_id}/items to fetch items with filtering.
      tags: [Lists]
      parameters:
        - name: id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetListResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/lists/{list_id}/items:
    get:
      operationId: listItems
      summary: List items in a list with filtering and sorting
      description: Returns items in a list. By default, archived and cancelled items are excluded.
      tags: [Items]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: |
            Filter by item status (can specify multiple).
            If not specified, archived and cancelled items are excluded by default.
            Use status=archived to explicitly include archived items.
          style: form
          explode: true
          schema:
            type: array
            items:
              type: string
              enum: [todo, in_progress, blocked, done, archived, cancelled]
            maxItems: 6
        - name: priority
          in: query
          description: Filter by item priority (can specify multiple for OR logic)
          style: form
          explode: true
          schema:
            type: array
            items:
              type: string
              enum: [low, medium, high, urgent]
            maxItems: 4
        - name: tags
          in: query
          description: Filter by tags (items must have all specified tags)
          style: form
          explode: true
          schema:
            type: array
            items:
              type: string
            maxItems: 5
        - name: sort_by
          in: query
          description: Field to sort by
          schema:
            type: string
            enum: [due_at, priority, created_at, updated_at]
            default: created_at
        - name: sort_dir
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
        - name: page_token
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Items retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      operationId: createItem
      summary: Create a new item in a list
      tags: [Items]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemRequest'
      responses:
        '201':
          description: Item created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateItemResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/lists/{list_id}/items/{item_id}:
    patch:
      operationId: updateItem
      summary: Update an existing item
      tags: [Items]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: item_id
          in: path
          required: true
          description: Item ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateItemResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      operationId: deleteItem
      summary: Delete a todo item
      description: |
        For recurring items: creates exception and archives item (soft delete).
        For non-recurring items: permanently deletes item.
      tags: [Items]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: item_id
          in: path
          required: true
          description: Item ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Item deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/lists/{list_id}/recurring-templates:
    post:
      operationId: createRecurringTemplate
      summary: Create a recurring item template
      tags: [RecurringTemplates]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRecurringTemplateRequest'
      responses:
        '201':
          description: Template created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateRecurringTemplateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      operationId: listRecurringTemplates
      summary: List recurring templates for a list
      tags: [RecurringTemplates]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: active_only
          in: query
          description: Filter for active templates only
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Templates retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListRecurringTemplatesResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/lists/{list_id}/recurring-templates/{template_id}:
    get:
      operationId: getRecurringTemplate
      summary: Get a recurring template by ID
      tags: [RecurringTemplates]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: template_id
          in: path
          required: true
          description: Template ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Template found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetRecurringTemplateResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      operationId: updateRecurringTemplate
      summary: Update a recurring template
      tags: [RecurringTemplates]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: template_id
          in: path
          required: true
          description: Template ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRecurringTemplateRequest'
      responses:
        '200':
          description: Template updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateRecurringTemplateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      operationId: deleteRecurringTemplate
      summary: Delete a recurring template
      tags: [RecurringTemplates]
      parameters:
        - name: list_id
          in: path
          required: true
          description: List ID
          schema:
            type: string
            format: uuid
        - name: template_id
          in: path
          required: true
          description: Template ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Template deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/admin/dead-letter-jobs:
    get:
      operationId: listDeadLetterJobs
      summary: List pending dead letter jobs
      tags: [Admin]
      parameters:
        - name: limit
          in: query
          description: Maximum number of jobs to return
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: List of dead letter jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListDeadLetterJobsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/admin/dead-letter-jobs/{id}/retry:
    post:
      operationId: retryDeadLetterJob
      summary: Retry a dead letter job
      tags: [Admin]
      parameters:
        - name: id
          in: path
          required: true
          description: Dead Letter Job ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Job scheduled for retry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetryDeadLetterJobResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/admin/dead-letter-jobs/{id}/discard:
    post:
      operationId: discardDeadLetterJob
      summary: Discard a dead letter job
      tags: [Admin]
      parameters:
        - name: id
          in: path
          required: true
          description: Dead Letter Job ID
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                note:
                  type: string
                  description: Reason for discarding
      responses:
        '204':
          description: Job discarded successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    # Request schemas
    CreateListRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 255
          example: "Shopping List"

    CreateListResponse:
      type: object
      properties:
        list:
          $ref: '#/components/schemas/TodoList'

    GetListResponse:
      type: object
      properties:
        list:
          $ref: '#/components/schemas/TodoList'

    ListListsResponse:
      type: object
      properties:
        lists:
          type: array
          nullable: false
          items:
            $ref: '#/components/schemas/TodoList'
        next_page_token:
          type: string

    CreateItemRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 255
        due_at:
          type: string
          format: date-time
        tags:
          type: array
          items:
            type: string
        priority:
          $ref: '#/components/schemas/ItemPriority'
        status:
          $ref: '#/components/schemas/ItemStatus'
          description: Initial status (defaults to 'todo' if not provided)
        estimated_duration:
          type: string
          description: ISO 8601 duration
          example: "PT2H30M"
        recurring_template_id:
          type: string
          format: uuid
        instance_date:
          type: string
          format: date-time
        timezone:
          type: string
          description: IANA timezone (e.g., 'Europe/Stockholm')
          example: "America/New_York"
        starts_at:
          type: string
          format: date
          description: |
            When the task becomes active/visible.
            For recurring items: set from the occurrence pattern.
            For direct items: explicitly set to schedule future tasks.
        due_offset:
          type: string
          description: |
            Duration from starts_at to due_at (ISO 8601 duration).
            If set with starts_at, due_at = starts_at + due_offset.
          example: "PT2H"

    CreateItemResponse:
      type: object
      properties:
        item:
          $ref: '#/components/schemas/TodoItem'

    UpdateItemRequest:
      type: object
      required:
        - update_mask
        - item
      properties:
        item:
          $ref: '#/components/schemas/TodoItem'
        update_mask:
          type: array
          minItems: 1
          items:
            type: string
            enum:
              - title
              - status
              - priority
              - due_at
              - starts_at
              - due_offset
              - tags
              - estimated_duration
              - actual_duration
              - timezone
          description: Fields to update. Unknown fields are rejected with 400.
          example: ["title", "status", "priority"]

    UpdateItemResponse:
      type: object
      properties:
        item:
          $ref: '#/components/schemas/TodoItem'

    ListItemsResponse:
      type: object
      properties:
        items:
          type: array
          nullable: false
          items:
            $ref: '#/components/schemas/TodoItem'
        next_page_token:
          type: string

    CreateRecurringTemplateRequest:
      type: object
      required:
        - title
        - recurrence_pattern
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 255
        tags:
          type: array
          items:
            type: string
        priority:
          $ref: '#/components/schemas/ItemPriority'
        estimated_duration:
          type: string
          description: ISO 8601 duration
        recurrence_pattern:
          $ref: '#/components/schemas/RecurrencePattern'
        recurrence_config:
          type: string
          description: JSON config for pattern-specific settings
        due_offset:
          type: string
          description: ISO 8601 duration offset from instance date
        sync_horizon_days:
          type: integer
          minimum: 1
          maximum: 90
          default: 14
          description: Days to generate immediately (SYNC layer)
        generation_horizon_days:
          type: integer
          minimum: 30
          maximum: 730
          default: 365
          description: Total generation horizon (ASYNC layer)

    CreateRecurringTemplateResponse:
      type: object
      properties:
        template:
          $ref: '#/components/schemas/RecurringItemTemplate'

    GetRecurringTemplateResponse:
      type: object
      properties:
        template:
          $ref: '#/components/schemas/RecurringItemTemplate'

    UpdateRecurringTemplateRequest:
      type: object
      required:
        - update_mask
        - template
      properties:
        template:
          $ref: '#/components/schemas/RecurringItemTemplate'
        update_mask:
          type: array
          minItems: 1
          items:
            type: string
            enum:
              - title
              - tags
              - priority
              - estimated_duration
              - recurrence_pattern
              - recurrence_config
              - due_offset
              - is_active
              - sync_horizon_days
              - generation_horizon_days
          description: Fields to update. Unknown fields are rejected with 400.

    UpdateRecurringTemplateResponse:
      type: object
      properties:
        template:
          $ref: '#/components/schemas/RecurringItemTemplate'

    ListRecurringTemplatesResponse:
      type: object
      properties:
        templates:
          type: array
          nullable: false
          items:
            $ref: '#/components/schemas/RecurringItemTemplate'

    # Domain models
    TodoList:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        created_at:
          type: string
          format: date-time
        total_items:
          type: integer
          description: Total items in this list
        undone_items:
          type: integer
          description: Items not yet done

    TodoItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        status:
          $ref: '#/components/schemas/ItemStatus'
        priority:
          $ref: '#/components/schemas/ItemPriority'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        due_at:
          type: string
          format: date-time
        starts_at:
          type: string
          format: date
          description: |
            When the task becomes active/visible.
            For recurring items: set from the occurrence pattern.
            For direct items: explicitly set to schedule future tasks.
          example: "2026-01-15"
        due_offset:
          type: string
          format: duration
          description: |
            Duration from starts_at to due_at (ISO 8601 duration).
            If set with starts_at, due_at = starts_at + due_offset.
          example: "PT2H"
        tags:
          type: array
          nullable: false
          items:
            type: string
        estimated_duration:
          type: string
          description: ISO 8601 duration
        actual_duration:
          type: string
          description: ISO 8601 duration
        recurring_template_id:
          type: string
          format: uuid
        instance_date:
          type: string
          format: date-time
        timezone:
          type: string
          description: IANA timezone
        etag:
          type: string
          description: Entity tag for optimistic concurrency control (RFC 7232). Quoted string format like "1", "2", etc.

    RecurringItemTemplate:
      type: object
      properties:
        id:
          type: string
          format: uuid
        list_id:
          type: string
          format: uuid
        title:
          type: string
        tags:
          type: array
          nullable: false
          items:
            type: string
        priority:
          $ref: '#/components/schemas/ItemPriority'
        estimated_duration:
          type: string
          description: ISO 8601 duration
        recurrence_pattern:
          $ref: '#/components/schemas/RecurrencePattern'
        recurrence_config:
          type: string
          description: JSON configuration
        due_offset:
          type: string
          description: ISO 8601 duration
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_generated_until:
          type: string
          format: date-time
        sync_horizon_days:
          type: integer
          default: 14
          minimum: 1
          maximum: 90
          description: Days to generate immediately on create/update (SYNC layer)
        generation_horizon_days:
          type: integer
          default: 365
          minimum: 30
          maximum: 730
          description: Total generation horizon in days (ASYNC layer)

    ListDeadLetterJobsResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/DeadLetterJob'

    RetryDeadLetterJobResponse:
      type: object
      properties:
        new_job_id:
          type: string
          format: uuid

    DeadLetterJob:
      type: object
      properties:
        id:
          type: string
          format: uuid
        template_id:
          type: string
          format: uuid
        generate_from:
          type: string
          format: date-time
        generate_until:
          type: string
          format: date-time
        error_type:
          type: string
        error_message:
          type: string
        failed_at:
          type: string
          format: date-time
        retry_count:
          type: integer
        last_worker_id:
          type: string
        original_job_id:
          type: string
          format: uuid
        
    # Enums
    ItemStatus:
      type: string
      enum:
        - todo
        - in_progress
        - blocked
        - done
        - archived
        - cancelled

    ItemPriority:
      type: string
      enum:
        - low
        - medium
        - high
        - urgent

    RecurrencePattern:
      type: string
      enum:
        - daily
        - weekly
        - biweekly
        - monthly
        - yearly
        - quarterly
        - weekdays

    # Error schemas
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: array
              nullable: false
              items:
                type: object
                properties:
                  field:
                    type: string
                  issue:
                    type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Unauthorized - invalid or missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: API key passed as Bearer token in Authorization header
